<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depósito en Solana</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca para generar QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- --- Bibliotecas de Solana --- -->
    
    <!-- 1. Buffer (necesario para web3.js en el navegador) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    
    <!-- Asignar Buffer globalmente ANTES de cargar solanaWeb3 -->
    <script>
        if (typeof buffer !== 'undefined') {
            window.Buffer = buffer.Buffer;
        }
    </script>

    <!-- 2. Solana Web3.js (Núcleo de Solana) -->
    <!-- Usamos 'unpkg' para obtener el build 'iife' (para navegador) -->
    <script src="https://unpkg.com/@solana/web3.js@1.91.8/lib/index.iife.min.js"></script>
    
    <!-- 3. Solana SPL Token (Para interactuar con tokens) -->
    <!-- Usamos 'cdnjs' para obtener el build 'iife' (para navegador) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/solana-spl-token/0.3.11/spl-token.iife.min.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        .qr-container canvas, .qr-container img {
            margin: auto;
            border-radius: 8px;
            border: 6px solid white;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6d28d9;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-md">
        
        <!-- Billetera de Destino -->
        <div class="mb-5">
            <label class="block text-sm font-medium text-gray-400 mb-1">Se depositará a la billetera:</label>
            <input 
                type="text" 
                readonly 
                value="23V6CXerzmncibRPGXL2q5kJ4LhqhG1Mr2Q81WJw7U7Q" 
                class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-gray-300 text-xs truncate select-all"
            >
        </div>

        <!-- Token (Mint Address) -->
        <div class="mb-5">
            <label class="block text-sm font-medium text-gray-400 mb-1">Token (Mint Address):</label>
            <input 
                type="text" 
                readonly 
                value="EU1CPckq2dRX2HXUdy7hZvhuwmx9DN3afSHL5wTopump" 
                class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-gray-300 text-xs truncate select-all"
                id="tokenMintAddress"
            >
        </div>

        <!-- Monto a Depositar -->
        <div class="mb-6">
            <label for="amount" class="block text-sm font-medium text-gray-400 mb-1">Monto a depositar (en Tokens)</label>
            <input 
                type="number" 
                id="amount" 
                min="0.000000001" 
                step="0.01" 
                placeholder="Ej: 10.5" 
                class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
            >
        </div>

        <!-- Pestañas para QR / Pago Directo -->
        <div class="mb-4 border-b border-gray-700">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button id="tab-qr" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-purple-500 text-purple-400">
                    Opción 1: Pagar con QR
                </button>
                <button id="tab-direct" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-300 hover:border-gray-500">
                    Opción 2: Pagar Directo
                </button>
            </nav>
        </div>

        <!-- Contenido de Pestañas -->
        <div id="tab-content-qr" class="tab-content">
            <!-- Botón Generar QR -->
            <button id="generateQR" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
                Generar QR de Pago
            </button>
            
            <!-- Contenedor del QR -->
            <div id="qr-message" class="text-center text-gray-400 text-sm mt-4"></div>
            <div id="qrcode" class="mt-6 qr-container bg-gray-700 rounded-lg p-4" style="display: none;">
                <p class="text-center text-gray-300 mb-3 font-medium">Escanea con tu billetera (Phantom, Solflare, etc.)</p>
                <!-- El QR se genera aquí -->
            </div>
        </div>

        <div id="tab-content-direct" class="tab-content" style="display: none;">
            <!-- Botón Conectar Phantom -->
            <button id="connectAndPay" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101m.758 4.899l-5.656 5.656"></path></svg>
                <span>Conectar Phantom y Pagar</span>
            </button>
            <div id="direct-payment-loader" class="mt-4 justify-center" style="display: none;">
                <div class="loader mx-auto"></div>
                <p class="text-center text-gray-400 text-sm mt-2">Procesando, por favor revisa tu billetera...</p>
            </div>
            <div id="direct-payment-message" class="text-center text-sm mt-4 break-words"></div>
        </div>

    </div>

    <!-- Script principal de la aplicación -->
    <script>
        // Este script espera a que TODA la página (incluyendo las bibliotecas externas) se cargue.
        window.addEventListener('load', () => {

            // --- Lógica de la Aplicación ---
            
            // La asignación de Buffer se movió al <head>
            // para que solanaWeb3.js la encuentre al cargarse.

            // La billetera de destino fija
            const RECIPIENT_WALLET = "23V6CXerzmncibRPGXL2q5kJ4LhqhG1Mr2Q81WJw7U7Q";
            // El token mint fijo
            const TOKEN_MINT = "EU1CPckq2dRX2HXUdy7hZvhuwmx9DN3afSHL5wTopump";

            // Elementos del DOM
            const amountInput = document.getElementById('amount');
            const qrButton = document.getElementById('generateQR');
            const qrCodeContainer = document.getElementById('qrcode');
            const qrMessage = document.getElementById('qr-message');
            
            const directPayButton = document.getElementById('connectAndPay');
            const directPayMessage = document.getElementById('direct-payment-message');
            const directPayLoader = document.getElementById('direct-payment-loader');

            const tabQr = document.getElementById('tab-qr');
            const tabDirect = document.getElementById('tab-direct');
            const tabContentQr = document.getElementById('tab-content-qr');
            const tabContentDirect = document.getElementById('tab-content-direct');

            let qrCodeInstance = null; // Para almacenar la instancia del QR

            // --- Lógica de Pestañas ---
            function switchTab(tabToShow) {
                if (tabToShow === 'qr') {
                    // Activar Tab QR
                    tabQr.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-500');
                    tabQr.classList.add('border-purple-500', 'text-purple-400');
                    tabContentQr.style.display = 'block';
                    
                    // Desactivar Tab Directo
                    tabDirect.classList.remove('border-purple-500', 'text-purple-400');
                    tabDirect.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-500');
                    tabContentDirect.style.display = 'none';
                } else {
                    // Activar Tab Directo
                    tabDirect.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-500');
                    tabDirect.classList.add('border-purple-500', 'text-purple-400');
                    tabContentDirect.style.display = 'block';

                    // Desactivar Tab QR
                    tabQr.classList.remove('border-purple-500', 'text-purple-400');
                    tabQr.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-500');
                    tabContentQr.style.display = 'none';
                }
            }

            tabQr.addEventListener('click', () => switchTab('qr'));
            tabDirect.addEventListener('click', () => switchTab('direct'));

            // --- Lógica del Generador de QR ---
            qrButton.addEventListener('click', () => {
                const amount = amountInput.value;
                
                // Limpiar mensajes y QR anterior
                qrCodeContainer.innerHTML = '<p class="text-center text-gray-300 mb-3 font-medium">Escanea con tu billetera (Phantom, Solflare, etc.)</p>';
                qrCodeContainer.style.display = 'none';
                qrMessage.textContent = '';
                qrMessage.classList.remove('text-red-400', 'text-green-400');

                // Validar monto
                if (!amount || parseFloat(amount) <= 0) {
                    qrMessage.textContent = 'Por favor, introduce un monto válido.';
                    qrMessage.classList.add('text-red-400');
                    return;
                }

                // Construir la URL de Solana Pay (versión corta para evitar overflow)
                // solana:<recipient_address>?amount=<amount>&spl-token=<token_mint>
                const solanaPayUrl = `solana:${RECIPIENT_WALLET}?amount=${amount}&spl-token=${TOKEN_MINT}`;

                try {
                    // Mostrar contenedor y generar QR
                    qrCodeContainer.style.display = 'block';
                    
                    // Usar el contenedor interno (después del texto) para el QR
                    const qrElement = document.createElement('div');
                    qrCodeContainer.appendChild(qrElement);

                    if (qrCodeInstance) {
                         // Limpiar QR anterior si existe (aunque ya limpiamos el innerHTML)
                    }

                    qrCodeInstance = new QRCode(qrElement, {
                        text: solanaPayUrl,
                        width: 256,
                        height: 256,
                        colorDark: "#ffffff",
                        colorLight: "#374151", // bg-gray-700
                        correctLevel: QRCode.CorrectLevel.M
                    });
                    
                    qrMessage.textContent = '¡QR generado exitosamente!';
                    qrMessage.classList.add('text-green-400');

                } catch (error) {
                    console.error("Error al generar QR:", error);
                    qrMessage.textContent = `Error al generar QR: ${error.message}`;
                    qrMessage.classList.add('text-red-400');
                    qrCodeContainer.style.display = 'none';
                }
            });


            // --- Lógica de Pago Directo (Phantom) ---
            
            // Función helper para mostrar mensajes
            function showDirectMessage(message, isError = false) {
                directPayMessage.textContent = message;
                if (isError) {
                    directPayMessage.classList.remove('text-green-400');
                    directPayMessage.classList.add('text-red-400');
                } else {
                    directPayMessage.classList.remove('text-red-400');
                    directPayMessage.classList.add('text-green-400');
                }
                directPayLoader.style.display = 'none';
                directPayButton.disabled = false;
            }

            // Evento principal del botón de pago directo
            directPayButton.addEventListener('click', async () => {
                directPayMessage.textContent = '';
                directPayLoader.style.display = 'flex';
                directPayButton.disabled = true;

                // 1. Verificar si Phantom (window.solana) existe
                const provider = window.solana;
                if (!provider || !provider.isPhantom) {
                    showDirectMessage('Error: No se detectó Phantom Wallet. Por favor, instálalo.', true);
                    return;
                }

                // 2. Conectar a la billetera
                let connection;
                let senderPublicKey;
                try {
                    const resp = await provider.connect();
                    senderPublicKey = resp.publicKey;
                    // Usar la red principal (mainnet-beta)
                    const rpcUrl = "https://api.mainnet-beta.solana.com"; 
                    connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');
                } catch (err) {
                    showDirectMessage('Error: El usuario rechazó la conexión.', true);
                    return;
                }

                // 3. Validar el monto
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    showDirectMessage('Por favor, introduce un monto válido.', true);
                    return;
                }

                try {
                    showDirectMessage('Preparando transacción...', false);
                    
                    // 4. Definir direcciones
                    const mintPublicKey = new solanaWeb3.PublicKey(TOKEN_MINT);
                    const recipientPublicKey = new solanaWeb3.PublicKey(RECIPIENT_WALLET);

                    // 5. Obtener los decimales del token (¡MUY IMPORTANTE!)
                    // Usamos splToken (del script cargado)
                    const mintInfo = await splToken.getMint(connection, mintPublicKey);
                    const decimals = mintInfo.decimals;
                    
                    // Calcular el monto en la unidad más pequeña (lamports para tokens)
                    const amountInSmallestUnit = BigInt(Math.round(amount * Math.pow(10, decimals)));
                    
                    if (amountInSmallestUnit === 0n) {
                         showDirectMessage('Error: El monto es demasiado pequeño.', true);
                         return;
                    }

                    // 6. Encontrar la cuenta de token (ATA) del *remitente* (el que paga)
                    const senderTokenAccountAddress = await splToken.getAssociatedTokenAddress(
                        mintPublicKey,
                        senderPublicKey
                    );

                    // 7. Encontrar la cuenta de token (ATA) del *destinatario* (el que recibe)
                    const recipientTokenAccountAddress = await splToken.getAssociatedTokenAddress(
                        mintPublicKey,
                        recipientPublicKey
                    );

                    // 8. Verificar si la cuenta de token del destinatario existe
                    const recipientAtaInfo = await connection.getAccountInfo(recipientTokenAccountAddress);

                    const transaction = new solanaWeb3.Transaction();
                    const instructions = [];

                    // 9. Si la cuenta del destinatario NO existe, añadir instrucción para crearla
                    if (recipientAtaInfo === null) {
                        instructions.push(
                            splToken.createAssociatedTokenAccountInstruction(
                                senderPublicKey, // El que paga la creación (payer)
                                recipientTokenAccountAddress, // La nueva cuenta ATA
                                recipientPublicKey, // El dueño de la nueva cuenta
                                mintPublicKey // El mint del token
                            )
                        );
                    }

                    // 10. Añadir la instrucción de transferencia
                    instructions.push(
                        splToken.createTransferInstruction(
                            senderTokenAccountAddress,    // Desde (fuente)
                            recipientTokenAccountAddress, // Hacia (destino)
                            senderPublicKey,              // Autoridad (dueño de la cuenta fuente)
                            amountInSmallestUnit          // Cantidad (en unidades pequeñas)
                        )
                    );
                    
                    transaction.add(...instructions);

                    // 11. Obtener el blockhash reciente
                    const { blockhash } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = senderPublicKey;

                    // 12. Solicitar firma y envío (NUEVO MÉTODO RECOMENDADO)
                    const { signature } = await provider.signAndSendTransaction(transaction);
                    
                    showDirectMessage('Transacción enviada. Esperando confirmación...', false);

                    // 13. Confirmar la transacción
                    await connection.confirmTransaction(signature, 'confirmed');

                    const explorerUrl = `https://solscan.io/tx/${signature}?cluster=mainnet`;
                    showDirectMessage(`¡Pago exitoso! Ver transacción: ${explorerUrl}`, false);
                    // Opcionalmente, limpiar el campo de monto
                    // amountInput.value = '';

                } catch (error) {
                    console.error("Error en el pago directo:", error);
                    let errorMessage = 'Error al procesar el pago.';
                    if (error.message.includes('User rejected')) {
                        errorMessage = 'Transacción rechazada por el usuario.';
                    } else if (error.message.includes('0x1')) {
                         errorMessage = 'Error: Fondos insuficientes o cuenta de token incorrecta.';
                    }
                    showDirectMessage(errorMessage, true);
                } finally {
                    directPayLoader.style.display = 'none';
                    directPayButton.disabled = false;
                }
            });

        });
    </script>
</body>
</html>

