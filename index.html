<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Depósito Token SPL</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carga de la biblioteca qrcode.min.js para generar los QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- --- ¡NUEVO! Bibliotecas de Solana --- -->
    
    <!-- 1. Buffer (necesario para web3.js en el navegador) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    
    <!-- 2. Solana Web3.js (Núcleo de Solana) -->
    <!-- Esto expone un objeto global 'solanaWeb3' -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/solana-web3.js/1.91.8/solana-web3.min.js"></script>
    
    <!-- 3. Solana SPL Token (Para interactuar con tokens) -->
    <!-- Esto expone un objeto global 'splToken' -->
    <script src="https://unpkg.com/@solana/spl-token@0.4.6/lib/index.iife.min.js"></script>

    <style>
        /* Estilos para el contenedor del QR para que el canvas/img se centre */
        #qr-container canvas,
        #qr-container img {
            margin: 0 auto;
            border-radius: 8px; /* Bordes redondeados para el QR */
            border: 6px solid white; /* Borde blanco alrededor del QR */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <!-- Contenedor principal centrado -->
    <div class="min-h-screen flex items-center justify-center p-4">
        
        <!-- Tarjeta del sistema de pago -->
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            
            <!-- Encabezado -->
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-white mb-2">
                    Depósito de <span class="text-purple-400">Token</span>
                </h1>
                <p class="text-gray-400">
                    Genere su código QR para pagar con un token SPL.
                </p>
            </div>

            <!-- Mostrar la Wallet de destino (informativo) -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-2">Se depositará a la billetera:</label>
                <div class="bg-gray-700 p-3 rounded-lg text-center text-xs text-purple-300 break-all">
                    23V6CXerzmncibRPGXL2q5kJ4LhqhG1Mr2Q81WJw7U7Q
                </div>
            </div>

            <!-- Mostrar el Token Mint (NUEVO) -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-2">Token (Mint Address):</label>
                <div class="bg-gray-700 p-3 rounded-lg text-center text-xs text-green-300 break-all" id="token-mint-address">
                    <!-- El token se insertará aquí desde JS -->
                </div>
            </div>

            <!-- Formulario de entrada -->
            <div>
                <!-- Campo para el monto -->
                <div class="mb-4">
                    <label for="sol-amount" class="block text-sm font-medium text-gray-300 mb-2">
                        Monto a depositar (en Tokens)
                    </label>
                    <input type="number"
                           id="sol-amount"
                           min="0.000001"
                           step="0.01"
                           placeholder="Ej: 0.5"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <!-- Botón para generar -->
                <button id="generate-qr-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out">
                    Generar QR de Pago
                </button>
            </div>

            <!-- Mensaje de error -->
            <div id="error-message" class="text-red-400 text-center text-sm mt-4"></div>

            <!-- Contenedor para el Código QR -->
            <div id="qr-container" class="mt-6 flex justify-center p-4 bg-gray-700 rounded-lg min-h-[280px] items-center">
                 <span class="text-gray-500">Aquí aparecerá el código QR</span>
            </div>

            <!-- --- ¡NUEVO! Sección de pago directo --- -->
            
            <!-- Divisor "O" -->
            <div class="relative flex items-center my-6">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink mx-4 text-gray-500 text-sm">O</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>

            <!-- Botón de Conectar y Pagar -->
            <div>
                <button id="connect-pay-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-wait">
                    Conectar Phantom y Pagar
                </button>
            </div>

            <!-- Mensajes para el pago directo -->
            <div id="connect-message" class="text-center text-sm mt-4 min-h-[20px]"></div>
            <!-- Fin de la nueva sección -->

            <!-- Disclaimer de seguridad -->
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    <strong>Importante:</strong> Esta herramienta solo genera la solicitud de pago.
                    No verifica si la transacción ha sido completada.
                </p>
            </div>

        </div>
    </div>

    <script>
    // --- ¡MODIFICADO! Esperar a que todo el DOM y TODOS LOS SCRIPTS estén cargados ---
    window.addEventListener('load', () => {

        // --- Lógica de la Aplicación ---
        
        // ¡Importante! Asignar Buffer globalmente para que solanaWeb3 lo encuentre
        // Las bibliotecas de Solana en el navegador dependen de 'Buffer'
        if (typeof buffer !== 'undefined') {
            window.Buffer = buffer.Buffer;
        }

        // La billetera de destino fija
        const RECIPIENT_WALLET = "23V6CXerzmncibRPGXL2q5kJ4LhqhG1Mr2Q81WJw7U7Q";
        
        // --- ¡NUEVO! Dirección del Mint del Token SPL ---
        const SPL_TOKEN_MINT = "EU1CPckq2dRX2HXUdy7hZvhuwmx9DN3afSHL5wTopump";

        // Elementos del DOM
        const generateBtn = document.getElementById("generate-qr-btn");
        const amountInput = document.getElementById("sol-amount");
        const qrContainer = document.getElementById("qr-container");
        const errorMessage = document.getElementById("error-message");
        const tokenMintDisplay = document.getElementById("token-mint-address"); // Nuevo elemento

        // --- ¡NUEVOS Elementos del DOM para Pago Directo ---
        const connectPayBtn = document.getElementById("connect-pay-btn");
        const connectMessage = document.getElementById("connect-message");

        // Instancia del QR (para poder limpiarla si es necesario)
        let qrCodeInstance = null;
        
        // --- ¡NUEVO! Poblar la dirección del token al cargar la página ---
        if(tokenMintDisplay) {
            tokenMintDisplay.textContent = SPL_TOKEN_MINT;
        }

        // Event Listener para el botón
        generateBtn.addEventListener('click', () => {
            const amount = parseFloat(amountInput.value);

            // Limpiar estado anterior
            errorMessage.textContent = "";
            
            // --- Validación de entrada ---
            if (!amount || amount <= 0) {
                errorMessage.textContent = "Por favor, ingrese un monto válido y mayor a cero.";
                // Limpiar el contenedor del QR
                if (qrCodeInstance) {
                    qrCodeInstance.clear(); // Limpia el QR existente
                }
                qrContainer.innerHTML = '<span class="text-gray-500">Aquí aparecerá el código QR</span>';
                return;
            }

            // --- Construcción de la URL de Solana Pay ---
            // solana:<recipient_address>?amount=<amount>&label=<label>&message=<message>
            // --- ¡MODIFICADO! Se añade el parámetro &spl-token= ---
            
            // --- MODIFICADO ---
            // Se eliminan 'label' y 'message' para acortar la URL
            // y prevenir el error "code length overflow" si el monto es muy largo.
            // const label = encodeURIComponent("Depósito Token");
            // const message = encodeURIComponent(`Pago de ${amount} Tokens por servicios.`);
            
            // Esta es la URL estándar de Solana Pay para TOKENS (versión corta)
            const solanaPayUrl = `solana:${RECIPIENT_WALLET}?amount=${amount}&spl-token=${SPL_TOKEN_MINT}`;

            // --- Generación del QR ---
            
            // Limpiar el contenedor antes de generar uno nuevo
            qrContainer.innerHTML = ""; 
            
            // Crear una nueva instancia de QRCode
            // La biblioteca qrcode.js se encargará de dibujar el QR dentro de 'qrContainer'
            qrCodeInstance = new QRCode(qrContainer, {
                text: solanaPayUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H // Alta corrección de errores
            });
        });

        // --- ¡NUEVA LÓGICA DE PAGO DIRECTO! ---

        // 1. Configuración de Solana
        // Estas definiciones ahora son seguras porque 'solanaWeb3' existe
        const RPC_URL = "https://api.mainnet-beta.solana.com"; // RPC Público de Solana
        const connection = new solanaWeb3.Connection(RPC_URL, "confirmed");
        
        // Convertimos las direcciones string a PublicKeys
        const recipientPubKey = new solanaWeb3.PublicKey(RECIPIENT_WALLET);
        const mintPubKey = new solanaWeb3.PublicKey(SPL_TOKEN_MINT);

        // 2. Event Listener para el nuevo botón
        connectPayBtn.addEventListener('click', async () => {
            // Deshabilitar botón y limpiar mensajes
            connectPayBtn.disabled = true;
            connectPayBtn.textContent = "Conectando...";
            connectMessage.textContent = "";
            errorMessage.textContent = ""; // Limpiar también el error del QR

            try {
                // 3. Verificar si Phantom (o una wallet compatible) está instalado
                const { solana } = window;
                if (!solana || !solana.isPhantom) {
                    throw new Error("Por favor, instale la billetera Phantom para usar esta función.");
                }

                // 4. Conectar la billetera
                await solana.connect();
                const senderPubKey = solana.publicKey;

                // 5. Obtener el monto (misma validación que el QR)
                const amount = parseFloat(amountInput.value);
                if (!amount || amount <= 0) {
                    throw new Error("Por favor, ingrese un monto válido y mayor a cero.");
                }

                connectPayBtn.textContent = "Preparando transacción...";

                // 6. Obtener decimales del Token (MUY IMPORTANTE)
                // Las transacciones de tokens se hacen en su unidad mínima (como centavos)
                const mintInfo = await splToken.getMint(connection, mintPubKey);
                const decimals = mintInfo.decimals;
                const amountInSmallestUnit = BigInt(Math.round(amount * Math.pow(10, decimals)));

                // 7. Encontrar las Cuentas de Token (ATA)
                // El que envía (sender) y el que recibe (recipient)
                const fromAta = await splToken.getAssociatedTokenAddress(mintPubKey, senderPubKey);
                const toAta = await splToken.getAssociatedTokenAddress(mintPubKey, recipientPubKey);

                // 8. Crear la transacción
                const transaction = new solanaWeb3.Transaction();

                // 9. (Opcional pero recomendado) Verificar si el destinatario tiene una cuenta de este token
                // Si no la tiene, se la creamos en la misma transacción.
                const toAtaInfo = await connection.getAccountInfo(toAta);
                if (!toAtaInfo) {
                    transaction.add(
                        splToken.createAssociatedTokenAccountInstruction(
                            senderPubKey, // El que paga la creación
                            toAta,
                            recipientPubKey,
                            mintPubKey
                        )
                    );
                }

                // 10. Añadir la instrucción de transferencia
                transaction.add(
                    splToken.createTransferInstruction(
                        fromAta,
                        toAta,
                        senderPubKey,
                        amountInSmallestUnit 
                        // NOTA: Si usas una versión antigua de spl-token, el 'amount' podría no aceptar BigInt.
                        // En ese caso, usa 'Number(amountInSmallestUnit)' si el monto no es astronómico.
                    )
                );

                // 11. Establecer el pagador de la tarifa y el blockhash
                transaction.feePayer = senderPubKey;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                connectPayBtn.textContent = "Confirme en su Billetera...";

                // 12. Firmar y enviar la transacción
                const { signature } = await solana.signAndSendTransaction(transaction);

                // 13. Confirmar la transacción
                connectPayBtn.textContent = "Confirmando en la red...";
                await connection.confirmTransaction(signature, 'confirmed');

                // 14. Éxito
                connectMessage.textContent = "¡Pago exitoso!";
                connectMessage.className = "text-green-400 text-center text-sm mt-4 min-h-[20px]";
                
                // Opcional: Mostrar la firma
                console.log("Firma de la transacción:", signature);

            } catch (error) {
                // 15. Manejo de errores
                console.error("Error en el pago:", error);
                const userDidCancel = error.code === 4001; // Código de error si el usuario rechaza
                
                if (userDidCancel) {
                    connectMessage.textContent = "Transacción cancelada por el usuario.";
                } else {
                    connectMessage.textContent = error.message || "Ocurrió un error desconocido.";
                }
                connectMessage.className = "text-red-400 text-center text-sm mt-4 min-h-[20px]";
            } finally {
                // 16. Reactivar el botón
                connectPayBtn.disabled = false;
                connectPayBtn.textContent = "Conectar Phantom y Pagar";
            }
        });

    }); // --- Fin del 'load' listener ---
    </script>

</body>
</html>

